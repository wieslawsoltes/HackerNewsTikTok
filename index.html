<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>HN TikTokâ€‘Style Stream (Fast Touch Navigation)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #111;
      color: #fff;
      touch-action: none;
    }
    .container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .page {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      overflow: hidden;
    }
    .bg-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(10px);
      transform: scale(1.1);
      z-index: 0;
      opacity: 1;
      transition: filter 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .story-content {
      position: relative;
      z-index: 1;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      max-height: 90%;
      color: #333;
      transition: none !important;
    }
    .story-content * {
      transition: none !important;
    }
    .story-content h2 {
      margin-top: 0;
      font-size: 1.5em;
    }
    .story-content a {
      color: #0077cc;
      text-decoration: none;
    }
    .preview-img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 5px;
      margin-bottom: 15px;
      transition: none !important;
    }
    .nav-buttons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      display: flex;
      gap: 20px;
    }
    .nav-buttons button {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.8);
      padding: 10px 20px;
      font-size: 20px;
      cursor: pointer;
      transition: none;
      opacity: 0.7;
    }
    .hn-link-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      padding: 8px;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      color: rgba(255, 255, 255, 0.8);
      transition: none;
    }
    .hn-link-icon i {
      font-size: 20px;
    }
    .hn-info {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: transparent;
      border: none;
      padding: 5px 10px;
      font-size: 14px;
      z-index: 2;
      color: rgba(255, 255, 255, 0.8);
      transition: none;
    }
    .feed-menu-toggle {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 20;
      cursor: pointer;
      background: transparent;
      padding: 8px;
      transition: none;
    }
    .feed-menu-toggle i {
      font-size: 24px;
      color: rgba(255, 255, 255, 0.8);
    }
    #refreshBtn {
      position: fixed;
      top: 10px;
      left: 60px;
      z-index: 20;
      cursor: pointer;
      background: transparent;
      padding: 8px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 24px;
      transition: none;
      opacity: 0.7;
    }
    .feed-menu {
      position: fixed;
      top: 60px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 5px;
      padding: 10px;
      z-index: 20;
      display: none;
      transition: none;
    }
    .feed-menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .feed-menu li a {
      text-decoration: none;
      color: rgba(255, 255, 255, 0.8);
      font-weight: bold;
      display: block;
      padding: 8px 12px;
      transition: none;
      opacity: 0.7;
    }
    @media (max-width: 600px) {
      .story-content {
        width: 90%;
        margin: 0 auto;
        padding: 15px;
      }
      .story-content h2 {
        font-size: 1.3em;
      }
      .preview-img {
        max-height: 200px;
      }
      .nav-buttons {
        bottom: 15px;
      }
      .nav-buttons button {
        padding: 12px 24px;
        font-size: 24px;
      }
      .hn-link-icon {
        top: 8px;
        right: 8px;
        padding: 10px;
      }
      .hn-link-icon i {
        font-size: 24px;
      }
      .hn-info {
        bottom: 8px;
        right: 8px;
        font-size: 16px;
        padding: 8px 12px;
      }
      .feed-menu-toggle {
        top: 8px;
        left: 8px;
        padding: 10px;
      }
      .feed-menu-toggle i {
        font-size: 28px;
      }
      #refreshBtn {
        top: 8px;
        left: 60px;
        font-size: 28px;
      }
      .feed-menu {
        top: 55px;
        left: 8px;
      }
    }
  </style>
</head>
<body>
  <div id="feedMenuToggle" class="feed-menu-toggle">
    <i class="fas fa-bars"></i>
  </div>
  <div id="refreshBtn">
    <i class="fas fa-sync-alt"></i>
  </div>
  <div id="feedMenu" class="feed-menu">
    <ul>
      <li><a href="#" data-feed="top">Top</a></li>
      <li><a href="#" data-feed="new">New</a></li>
      <li><a href="#" data-feed="best">Best</a></li>
      <li><a href="#" data-feed="ask">Ask</a></li>
      <li><a href="#" data-feed="show">Show</a></li>
      <li><a href="#" data-feed="job">Jobs</a></li>
    </ul>
  </div>
  <div id="container" class="container"></div>
  <div class="nav-buttons">
    <button id="prevBtn" title="Previous"><i class="fas fa-chevron-up"></i></button>
    <button id="nextBtn" title="Next"><i class="fas fa-chevron-down"></i></button>
  </div>
  <script>
    const container = document.getElementById('container');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const feedMenuToggle = document.getElementById('feedMenuToggle');
    const feedMenu = document.getElementById('feedMenu');
    const refreshBtn = document.getElementById('refreshBtn');

    const storyCache = {};
    const previewCache = {};

    let currentIndex = 0;
    let stories = [];
    let storyIds = [];
    let currentBatchIndex = 0;
    const batchSize = 10;
    let currentFeed = 'top';

    const feedEndpoints = {
      top: 'https://hacker-news.firebaseio.com/v0/topstories.json',
      new: 'https://hacker-news.firebaseio.com/v0/newstories.json',
      best: 'https://hacker-news.firebaseio.com/v0/beststories.json',
      ask: 'https://hacker-news.firebaseio.com/v0/askstories.json',
      show: 'https://hacker-news.firebaseio.com/v0/showstories.json',
      job: 'https://hacker-news.firebaseio.com/v0/jobstories.json'
    };

    function renderPage(index) {
      const pages = document.querySelectorAll('.page');
      pages.forEach((page, i) => {
        if (i === index) {
          page.style.transform = 'translateY(0)';
        } else if (i < index) {
          page.style.transform = 'translateY(-100%)';
        } else {
          page.style.transform = 'translateY(100%)';
        }
      });
    }

    function createPage(story) {
      const page = document.createElement('div');
      page.classList.add('page');

      const bgDiv = document.createElement('div');
      bgDiv.classList.add('bg-image');
      page.appendChild(bgDiv);

      const contentDiv = document.createElement('div');
      contentDiv.classList.add('story-content');
      contentDiv.innerHTML = `
        <h2>${story.title || 'No Title'}</h2>
        <p>by <strong>${story.by || 'Unknown'}</strong> | ${story.score || 0} points</p>
        <p>${story.url ? `<a href="${story.url}" target="_blank">${story.url}</a>` : 'No link available'}</p>
      `;
      page.appendChild(contentDiv);

      const hnLink = document.createElement('a');
      hnLink.classList.add('hn-link-icon');
      hnLink.href = `https://news.ycombinator.com/item?id=${story.id}`;
      hnLink.target = '_blank';
      hnLink.innerHTML = `<i class="fas fa-external-link-alt"></i>`;
      page.appendChild(hnLink);

      const rank = stories.indexOf(story) + 1;
      const hnInfo = document.createElement('div');
      hnInfo.classList.add('hn-info');
      hnInfo.textContent = `#${rank} | ${story.descendants || 0} comments`;
      page.appendChild(hnInfo);

      if (story.url) {
        fetchPreviewData(story.url).then(previewData => {
          if (previewData && previewData.image && previewData.image.url) {
            const imageUrl = previewData.image.url;
            bgDiv.style.backgroundImage = `url('${imageUrl}')`;
            const imgEl = document.createElement('img');
            imgEl.classList.add('preview-img');
            imgEl.src = imageUrl;
            imgEl.alt = previewData.title || story.title || 'Preview Image';
            contentDiv.insertBefore(imgEl, contentDiv.firstChild);
            if (previewData.description) {
              const descP = document.createElement('p');
              descP.textContent = previewData.description;
              contentDiv.appendChild(descP);
            }
          }
        }).catch(err => {
          console.error('Error fetching preview data:', err);
        });
      }
      return page;
    }

    async function fetchPreviewData(url) {
      if (previewCache[url]) {
        return Promise.resolve(previewCache[url]);
      }
      try {
        const apiUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}&meta=true`;
        const response = await fetch(apiUrl);
        const data = await response.json();
        if (data && data.data) {
          previewCache[url] = data.data;
          return data.data;
        }
      } catch (error) {
        console.error('Error in fetchPreviewData:', error);
      }
      return null;
    }

    async function loadNextBatch() {
      if (currentBatchIndex >= storyIds.length) return;
      const idsToLoad = storyIds.slice(currentBatchIndex, currentBatchIndex + batchSize);
      currentBatchIndex += batchSize;

      const promises = idsToLoad.map(id => {
        if (storyCache[id]) {
          return Promise.resolve(storyCache[id]);
        } else {
          return fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`)
            .then(res => res.json())
            .then(data => { storyCache[id] = data; return data; });
        }
      });
      try {
        const newStories = await Promise.all(promises);
        newStories.forEach(story => {
          if (story && story.title) {
            stories.push(story);
            const page = createPage(story);
            container.appendChild(page);
          }
        });
        renderPage(currentIndex);
        setupIntersectionObserver();
      } catch (error) {
        console.error('Error loading batch:', error);
      }
    }

    async function fetchStoryIds(feed) {
      try {
        const res = await fetch(feedEndpoints[feed]);
        storyIds = await res.json();
        currentBatchIndex = 0;
        currentIndex = 0;
        stories = [];
        container.innerHTML = '';
        loadNextBatch();
      } catch (error) {
        console.error('Error fetching story IDs:', error);
      }
    }

    function goToNextPage() {
      if (currentIndex < stories.length - 1) {
        currentIndex++;
        renderPage(currentIndex);
        checkAndLoadMore();
      }
    }
    function goToPrevPage() {
      if (currentIndex > 0) {
        currentIndex--;
        renderPage(currentIndex);
      }
    }
    function checkAndLoadMore() {
      // Preload next few items when closer to the end
      if (currentIndex >= stories.length - 5 && currentBatchIndex < storyIds.length) {
        loadNextBatch();
      }
    }
    function refreshFeed() {
      fetchStoryIds(currentFeed);
    }

    let touchStartY = null;
    document.addEventListener('touchstart', (e) => {
      touchStartY = e.changedTouches[0].screenY;
    });
    document.addEventListener('touchmove', (e) => {
      if (touchStartY === null) return;
      const currentY = e.changedTouches[0].screenY;
      const delta = currentY - touchStartY;
      const percent = (delta / window.innerHeight) * 100;
      updateDragging(percent);
      e.preventDefault();
    });
    document.addEventListener('touchend', (e) => {
      if (touchStartY === null) return;
      const currentY = e.changedTouches[0].screenY;
      const delta = currentY - touchStartY;
      document.querySelectorAll('.page').forEach(page => page.style.transition = '');
      if (delta > 50) {
        goToPrevPage();
      } else if (delta < -50) {
        goToNextPage();
      } else {
        renderPage(currentIndex);
      }
      touchStartY = null;
    });
    function updateDragging(percent) {
      const pages = document.querySelectorAll('.page');
      const progress = Math.min(1, Math.abs(percent) / 100);
      if (pages[currentIndex]) {
        pages[currentIndex].style.transition = 'none';
        pages[currentIndex].style.transform = `translateY(${percent}%)`;
        const bg = pages[currentIndex].querySelector('.bg-image');
        if (bg) {
          const newBlur = 10 - progress * 10;
          bg.style.filter = `blur(${newBlur}px)`;
          bg.style.opacity = 1; /* Ensure opacity remains 1 */
        }
      }
      if (percent < 0 && currentIndex < pages.length - 1 && pages[currentIndex + 1]) {
        pages[currentIndex + 1].style.transition = 'none';
        pages[currentIndex + 1].style.transform = `translateY(${100 + percent}%)`;
        const bg = pages[currentIndex + 1].querySelector('.bg-image');
        if (bg) {
          const newBlur = progress * 10;
          bg.style.filter = `blur(${newBlur}px)`;
          bg.style.opacity = 1; /* Ensure opacity remains 1 */
        }
      }
      if (percent > 0 && currentIndex > 0 && pages[currentIndex - 1]) {
        pages[currentIndex - 1].style.transition = 'none';
        pages[currentIndex - 1].style.transform = `translateY(${-100 + percent}%)`;
        const bg = pages[currentIndex - 1].querySelector('.bg-image');
        if (bg) {
          const newBlur = progress * 10;
          bg.style.filter = `blur(${newBlur}px)`;
          bg.style.opacity = 1; /* Ensure opacity remains 1 */
        }
      }
    }

    prevBtn.addEventListener('click', goToPrevPage);
    nextBtn.addEventListener('click', goToNextPage);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp') goToPrevPage();
      else if (e.key === 'ArrowDown') goToNextPage();
    });
    let lastWheelTime = 0;
    document.addEventListener('wheel', (e) => {
      e.preventDefault();
      const now = Date.now();
      if (now - lastWheelTime < 600) return;
      lastWheelTime = now;
      if (e.deltaY > 0) goToNextPage();
      else if (e.deltaY < 0) goToPrevPage();
    }, { passive: false, capture: true });
    feedMenuToggle.addEventListener('click', () => {
      if (getComputedStyle(feedMenu).display === 'none') {
        feedMenu.style.display = 'block';
      } else {
        feedMenu.style.display = 'none';
      }
    });
    refreshBtn.addEventListener('click', refreshFeed);
    feedMenu.addEventListener('click', (e) => {
      e.preventDefault();
      let target = e.target;
      if (target.tagName.toLowerCase() !== 'a' && target.parentElement && target.parentElement.tagName.toLowerCase() === 'a') {
        target = target.parentElement;
      }
      if (target && target.tagName.toLowerCase() === 'a') {
        const selectedFeed = target.getAttribute('data-feed');
        if (selectedFeed && selectedFeed !== currentFeed) {
          currentFeed = selectedFeed;
          feedMenu.style.display = 'none';
          fetchStoryIds(currentFeed);
        }
      }
    });

    function setupIntersectionObserver() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const pageIndex = Array.from(container.children).indexOf(entry.target);
            if (pageIndex === stories.length - 3) {
              loadNextBatch();
            }
          }
        });
      }, {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
      });

      document.querySelectorAll('.page').forEach(page => {
        observer.observe(page);
      });
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }

    fetchStoryIds(currentFeed);
  </script>
  <script>
    // Service Worker script
    self.addEventListener('install', event => {
      event.waitUntil(
        caches.open('hn-cache').then(cache => {
          return cache.addAll([
            '/',
            'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css',
            // Add other static assets to cache
          ]);
        })
      );
    });

    self.addEventListener('fetch', event => {
      event.respondWith(
        caches.match(event.request).then(response => {
          return response || fetch(event.request);
        })
      );
    });
  </script>
</body>
</html>
